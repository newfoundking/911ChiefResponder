<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle Icon Studio</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; color: #111; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    h1 { margin-top: 0; }
    .layout { display: grid; grid-template-columns: 340px 1fr; gap: 16px; }
    .panel { background: #fff; border: 1px solid #d9dee5; border-radius: 10px; padding: 12px; }
    .panel h2 { margin: 0 0 8px; font-size: 18px; }
    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cfd8e3; border-radius: 6px; }
    input[type="color"] { padding: 2px; height: 38px; }
    input[type="range"] { width: 100%; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .actions button { font-weight: 700; cursor: pointer; }
    .preview-wrap { display: grid; grid-template-columns: 1fr 220px; gap: 12px; align-items: start; }
    .canvas-box { background: repeating-conic-gradient(#eee 0% 25%, #ddd 0% 50%) 50% / 16px 16px; border: 1px solid #d9dee5; border-radius: 10px; padding: 12px; }
    canvas { image-rendering: auto; display: block; margin: 0 auto; }
    .stack { display: grid; gap: 8px; }
    .hint { font-size: 12px; color: #4b5563; line-height: 1.35; }
    .status { min-height: 22px; font-weight: 700; }
    .status.error { color: #b91c1c; }
    .status.ok { color: #047857; }
    .mini { width: 128px; height: 128px; border: 1px solid #d9dee5; border-radius: 8px; margin: 0 auto; }
    .top-links { display: flex; gap: 8px; margin-bottom: 12px; }
    .top-links a { text-decoration: none; background: #0b6cff; color: #fff; padding: 8px 12px; border-radius: 8px; font-weight: 700; }
    .top-links a.secondary { background: #374151; }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } .preview-wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-links">
      <a href="/index.html">Back to CAD</a>
      <a class="secondary" href="/mobile.html">Mobile</a>
    </div>
    <h1>Vehicle Icon Studio</h1>
    <p class="hint">Upload a vehicle image, remove the background, add configurable flashing lights, then export as transparent PNG or animated GIF for later assignment.</p>

    <div class="layout">
      <section class="panel stack">
        <h2>1) Image + Cutout</h2>
        <label for="sourceImage">Vehicle image</label>
        <input id="sourceImage" type="file" accept="image/*" />

        <label for="modelQuality">Segmentation quality</label>
        <select id="modelQuality">
          <option value="pascal">Fast (pascal)</option>
          <option value="cityscapes" selected>Vehicle-focused (cityscapes)</option>
          <option value="ade20k">Detailed (ade20k)</option>
        </select>

        <label for="maskMode">Mask mode</label>
        <select id="maskMode">
          <option value="vehicle">Vehicle classes only</option>
          <option value="foreground" selected>Any non-background object</option>
        </select>

        <label for="maskThreshold">Edge alpha cutoff</label>
        <input id="maskThreshold" type="range" min="0" max="255" step="1" value="16" />

        <label><input id="autoCrop" type="checkbox" style="width:auto;"> Auto-crop to detected object</label>
        <label for="cropPadding">Crop padding</label>
        <input id="cropPadding" type="range" min="0" max="0.4" step="0.01" value="0.04" />

        <button id="segmentBtn" type="button">Remove Background</button>

        <h2>2) Icon Layout</h2>
        <div class="row">
          <div>
            <label for="iconSize">Icon size</label>
            <select id="iconSize">
              <option value="24">24x24</option>
              <option value="30">30x30</option>
              <option value="36" selected>36x36</option>
              <option value="48">48x48</option>
              <option value="64">64x64</option>
            </select>
          </div>
          <div>
            <label for="zoom">Vehicle zoom</label>
            <input id="zoom" type="range" min="0.4" max="2.6" step="0.01" value="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="offsetX">Offset X</label>
            <input id="offsetX" type="range" min="-0.8" max="0.8" step="0.01" value="0" />
          </div>
          <div>
            <label for="offsetY">Offset Y</label>
            <input id="offsetY" type="range" min="-0.8" max="0.8" step="0.01" value="0.12" />
          </div>
        </div>

        <h2>3) Flashing Lights</h2>
        <label><input id="lightsEnabled" type="checkbox" checked style="width:auto;"> Enable flashing lights</label>
        <div class="row">
          <div>
            <label for="groupPatternA">Group A pattern</label>
            <select id="groupPatternA">
              <option value="alternate">Alternate</option>
              <option value="simultaneous">Simultaneous</option>
              <option value="sweep">Sweep</option>
              <option value="pulse">Pulse</option>
            </select>
          </div>
          <div>
            <label for="groupPatternB">Group B pattern</label>
            <select id="groupPatternB">
              <option value="alternate">Alternate</option>
              <option value="simultaneous">Simultaneous</option>
              <option value="sweep" selected>Sweep</option>
              <option value="pulse">Pulse</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fps">Flash speed (fps)</label>
            <input id="fps" type="range" min="2" max="24" step="1" value="8" />
          </div>
          <div>
            <label for="selectedLight">Edit light #</label>
            <select id="selectedLight">
              <option value="0">1</option>
              <option value="1">2</option>
              <option value="2">3</option>
              <option value="3">4</option>
            </select>
          </div>
        </div>
        <label for="lightIntensity">Light intensity</label>
        <input id="lightIntensity" type="range" min="0" max="1" step="0.01" value="0.9" />

        <div class="row">
          <div>
            <label for="lightX">Light X position</label>
            <input id="lightX" type="range" min="0" max="1" step="0.01" value="0.36" />
          </div>
          <div>
            <label for="lightY">Light Y position</label>
            <input id="lightY" type="range" min="0" max="1" step="0.01" value="0.25" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="lightColor">Light color</label>
            <input id="lightColor" type="color" value="#ff0000" />
          </div>
          <div>
            <label for="lightGroup">Light group</label>
            <select id="lightGroup">
              <option value="A">A</option>
              <option value="B">B</option>
            </select>
          </div>
        </div>
        <label for="lightPatternMode">Light pattern mode</label>
        <select id="lightPatternMode">
          <option value="group">Use group pattern</option>
          <option value="alternate">Alternate</option>
          <option value="simultaneous">Simultaneous</option>
          <option value="sweep">Sweep</option>
          <option value="pulse">Pulse</option>
        </select>

        <div class="actions">
          <button id="downloadPngBtn" type="button">Download PNG</button>
          <button id="downloadGifBtn" type="button">Download GIF</button>
        </div>

        <div id="status" class="status"></div>
      </section>

      <section class="panel">
        <h2>Preview</h2>
        <div class="preview-wrap">
          <div class="canvas-box">
            <canvas id="previewCanvas" width="360" height="360"></canvas>
          </div>
          <div class="stack">
            <div>
              <label>Actual icon preview</label>
              <canvas id="miniPreview" class="mini" width="128" height="128"></canvas>
            </div>
            <p class="hint">Tip: segmentation keeps the full frame first. If detection is too aggressive, switch mask mode to "Any non-background object" and lower edge cutoff. Turn on auto-crop only after you confirm the result.</p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/deeplab@0.2.1/dist/deeplab.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@1.0.1/dist/gif.js"></script>
  <script type="module" src="/js/icon-studio.js"></script>
</body>
</html>
