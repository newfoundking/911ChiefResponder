<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vehicle Icon Studio</title>
  <style>
    :root { color-scheme: light; }
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; color: #111; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .top-links { display: flex; gap: 8px; margin-bottom: 12px; }
    .top-links a { text-decoration: none; background: #0b6cff; color: #fff; padding: 8px 12px; border-radius: 8px; font-weight: 700; }
    .top-links a.secondary { background: #374151; }
    .header-row { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; flex-wrap: wrap; }
    h1 { margin: 0; }
    .status { min-height: 22px; font-weight: 700; }
    .status.error { color: #b91c1c; }
    .status.ok { color: #047857; }
    .hint { font-size: 12px; color: #4b5563; line-height: 1.35; }

    .workspace { display: grid; grid-template-columns: minmax(0, 1fr) 280px; gap: 12px; align-items: start; }
    .focus-column { display: grid; gap: 10px; }
    .view-toggle { display: inline-flex; background: #e5e7eb; border-radius: 10px; padding: 4px; gap: 4px; width: fit-content; }
    .view-btn { border: 0; background: transparent; padding: 8px 14px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .view-btn.active { background: #111827; color: #fff; }

    .focus-stage { width: 100%; min-height: 560px; display: grid; place-items: center; background: #fff; border: 1px solid #d9dee5; border-radius: 12px; padding: 12px; }
    .canvas-box { width: 100%; height: 100%; display: grid; place-items: center; background: repeating-conic-gradient(#eee 0% 25%, #ddd 0% 50%) 50% / 16px 16px; border: 1px solid #d9dee5; border-radius: 10px; }
    canvas { image-rendering: auto; display: block; margin: 0 auto; }
    #previewCanvas { width: min(100%, 720px); height: auto; }
    #editorCanvas { width: min(100%, 720px); height: auto; border: 1px solid #d9dee5; border-radius: 8px; cursor: crosshair; background: repeating-conic-gradient(#eee 0% 25%, #ddd 0% 50%) 50% / 16px 16px; }

    .side-column { background: #fff; border: 1px solid #d9dee5; border-radius: 10px; padding: 10px; display: grid; gap: 12px; }
    .actual-preview { display: grid; gap: 8px; }
    .mini-window { min-height: 70px; border: 1px solid #d9dee5; border-radius: 8px; background: repeating-conic-gradient(#eee 0% 25%, #ddd 0% 50%) 50% / 16px 16px; padding: 8px; display: grid; justify-content: start; align-content: start; overflow: auto; }
    .mini { width: auto; height: auto; border: 1px solid #374151; border-radius: 4px; background: transparent; }

    .actions { display: grid; grid-template-columns: 1fr; gap: 8px; }
    .actions button { font-weight: 700; cursor: pointer; }

    .options-panel { margin-top: 14px; background: #fff; border: 1px solid #d9dee5; border-radius: 10px; padding: 12px; }
    .tabs { display: flex; gap: 6px; flex-wrap: wrap; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; margin-bottom: 10px; }
    .tab-btn { width: auto; border: 1px solid #cfd8e3; background: #f9fafb; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 700; }
    .tab-btn.active { background: #0b6cff; color: #fff; border-color: #0b6cff; }
    .tab-content { display: none; }
    .tab-content.active { display: grid; }
    .section-grid { gap: 8px; }

    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    input, select, button { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #cfd8e3; border-radius: 6px; }
    input[type="color"] { padding: 2px; height: 38px; }
    input[type="range"] { width: 100%; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .fine-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    @media (max-width: 980px) {
      .workspace { grid-template-columns: 1fr; }
      .side-column { order: 2; }
      .focus-stage { min-height: 460px; }
    }
    @media (max-width: 720px) {
      .row, .fine-actions { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top-links">
      <a href="/index.html">Back to CAD</a>
      <a class="secondary" href="/mobile.html">Mobile</a>
    </div>

    <div class="header-row">
      <h1>Vehicle Icon Studio</h1>
      <div id="status" class="status"></div>
    </div>
    <p class="hint">Upload a vehicle image, remove the background, add configurable flashing lights, then export as transparent PNG or animated GIF for later assignment.</p>

    <section class="workspace">
      <div class="focus-column">
        <div class="view-toggle" role="group" aria-label="Focus view">
          <button type="button" id="focusPreviewBtn" class="view-btn active">Preview Focus</button>
          <button type="button" id="focusMaskBtn" class="view-btn">Manual Mask Focus</button>
        </div>
        <div class="focus-stage">
          <div id="previewCanvasWrap" class="canvas-box">
            <canvas id="previewCanvas" width="720" height="720"></canvas>
          </div>
          <canvas id="editorCanvas" width="720" height="720" style="display:none;"></canvas>
        </div>
      </div>

      <aside class="side-column">
        <div class="actual-preview">
          <strong>Actual icon preview (real output size)</strong>
          <div class="mini-window">
            <canvas id="miniPreview" class="mini" width="36" height="36"></canvas>
          </div>
        </div>

        <div class="actions">
          <button id="downloadPngBtn" type="button">Download PNG</button>
          <button id="downloadGifBtn" type="button">Download GIF</button>
        </div>
      </aside>
    </section>

    <section class="options-panel">
      <div class="tabs" role="tablist" aria-label="Studio sections">
        <button type="button" class="tab-btn active" data-tab="cutout">Image + Cutout</button>
        <button type="button" class="tab-btn" data-tab="cleanup">Manual Cleanup</button>
        <button type="button" class="tab-btn" data-tab="layout">Icon Layout</button>
        <button type="button" class="tab-btn" data-tab="lights">Flashing Lights</button>
      </div>

      <div id="tab-cutout" class="tab-content active section-grid">
        <label for="sourceImage">Vehicle image</label>
        <input id="sourceImage" type="file" accept="image/*" />

        <label for="modelQuality">Segmentation quality</label>
        <select id="modelQuality">
          <option value="pascal">Fast (pascal)</option>
          <option value="cityscapes" selected>Vehicle-focused (cityscapes)</option>
          <option value="ade20k">Detailed (ade20k)</option>
        </select>

        <label for="maskMode">Mask mode</label>
        <select id="maskMode">
          <option value="vehicle">Vehicle classes only</option>
          <option value="foreground" selected>Any non-background object</option>
        </select>

        <label for="maskThreshold">Edge alpha cutoff</label>
        <input id="maskThreshold" type="range" min="0" max="255" step="1" value="16" />

        <label><input id="autoCrop" type="checkbox" style="width:auto;"> Auto-crop to detected object</label>
        <label for="cropPadding">Crop padding</label>
        <input id="cropPadding" type="range" min="0" max="0.4" step="0.01" value="0.04" />

        <button id="segmentBtn" type="button">Remove Background</button>
      </div>

      <div id="tab-cleanup" class="tab-content section-grid">
        <label for="refineMode">Brush mode</label>
        <select id="refineMode">
          <option value="keep">Keep area</option>
          <option value="remove">Remove area</option>
        </select>

        <label for="refineBrushSize">Brush size</label>
        <input id="refineBrushSize" type="range" min="2" max="80" step="1" value="16" />

        <label><input id="smartRefine" type="checkbox" checked style="width:auto;"> Smart assist (match nearby similar colors)</label>
        <label for="smartTolerance">Smart tolerance</label>
        <input id="smartTolerance" type="range" min="10" max="200" step="1" value="75" />

        <div class="fine-actions">
          <button id="resetRefineBtn" type="button">Reset manual edits</button>
          <button id="invertRefineBtn" type="button">Invert keep/remove mode</button>
        </div>
        <p class="hint">Tip: use the manual mask editor to paint keep/remove areas. Turn on Smart assist to spread each brush stroke to nearby pixels with similar color so cleanup is faster.</p>
      </div>

      <div id="tab-layout" class="tab-content section-grid">
        <div class="row">
          <div>
            <label for="iconSize">Icon size</label>
            <select id="iconSize">
              <option value="36" selected>36x36</option>
              <option value="64">64x64</option>
              <option value="128">128x128</option>
              <option value="256">256x256</option>
            </select>
          </div>
          <div>
            <label for="zoom">Vehicle zoom</label>
            <input id="zoom" type="range" min="0.4" max="2.6" step="0.01" value="1" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="offsetX">Offset X</label>
            <input id="offsetX" type="range" min="-0.8" max="0.8" step="0.01" value="0" />
          </div>
          <div>
            <label for="offsetY">Offset Y</label>
            <input id="offsetY" type="range" min="-0.8" max="0.8" step="0.01" value="0.12" />
          </div>
        </div>
      </div>

      <div id="tab-lights" class="tab-content section-grid">
        <label><input id="lightsEnabled" type="checkbox" checked style="width:auto;"> Enable flashing lights</label>
        <div class="row">
          <div>
            <label for="groupPatternA">Group A pattern</label>
            <select id="groupPatternA">
              <option value="alternate">Alternate</option>
              <option value="simultaneous">Simultaneous</option>
              <option value="sweep">Sweep</option>
              <option value="pulse">Pulse</option>
            </select>
          </div>
          <div>
            <label for="groupPatternB">Group B pattern</label>
            <select id="groupPatternB">
              <option value="alternate">Alternate</option>
              <option value="simultaneous">Simultaneous</option>
              <option value="sweep" selected>Sweep</option>
              <option value="pulse">Pulse</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="fps">Flash speed (fps)</label>
            <input id="fps" type="range" min="2" max="24" step="1" value="8" />
          </div>
          <div>
            <label for="selectedLight">Selected light</label>
            <select id="selectedLight"></select>
          </div>
        </div>

        <div class="fine-actions" style="margin-top: 4px;">
          <button id="addLightBtn" type="button">Add Light</button>
          <button id="removeLightBtn" type="button">Remove Light</button>
        </div>

        <p class="hint">Click the big preview to place the selected light.</p>
        <label for="lightIntensity">Light intensity</label>
        <input id="lightIntensity" type="range" min="0" max="1" step="0.01" value="0.9" />

        <div class="row">
          <div>
            <label for="lightX">Light X position</label>
            <input id="lightX" type="number" min="0" max="1" step="0.01" value="0.36" />
          </div>
          <div>
            <label for="lightY">Light Y position</label>
            <input id="lightY" type="number" min="0" max="1" step="0.01" value="0.25" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="lightColor">Light color</label>
            <input id="lightColor" type="color" value="#ff0000" />
          </div>
          <div>
            <label for="lightGroup">Light group</label>
            <select id="lightGroup">
              <option value="A">A</option>
              <option value="B">B</option>
            </select>
          </div>
        </div>
        <label for="lightPatternMode">Light pattern mode</label>
        <select id="lightPatternMode">
          <option value="group">Use group pattern</option>
          <option value="alternate">Alternate</option>
          <option value="simultaneous">Simultaneous</option>
          <option value="sweep">Sweep</option>
          <option value="pulse">Pulse</option>
        </select>

        <div class="row">
          <div>
            <label for="lightSpeed">Per-light speed multiplier</label>
            <input id="lightSpeed" type="number" min="0.25" max="4" step="0.05" value="1" />
          </div>
          <div>
            <label for="lightFlashOffsetMs">Flash offset (ms)</label>
            <input id="lightFlashOffsetMs" type="number" min="0" max="2000" step="10" value="0" />
          </div>
        </div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/deeplab@0.2.1/dist/deeplab.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gif.js.optimized@1.0.1/dist/gif.js"></script>
  <script type="module" src="/js/icon-studio.js"></script>
</body>
</html>
